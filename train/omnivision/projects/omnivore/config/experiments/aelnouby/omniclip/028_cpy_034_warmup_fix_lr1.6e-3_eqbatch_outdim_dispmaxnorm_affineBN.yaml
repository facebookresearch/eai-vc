# @package _global_

defaults:
  - /experiments/imisra/074_simpletx_nomask_vitb32_laion21M_sunrgbdisp50x_imval_srgbdval_linheads_eqbatch_dispmaxnorm_ep32
out_dim: 512

trainer:
  model:
    multimodal_model:
      postprocessors:
          - name: "normalize"
            postprocessor:
              _target_: omnivore.models.helpers.NormalizeAndBatchNorm
              dim: -1
              out_features: ${out_dim}
          - name: "normalize_and_scale_text"
            postprocessor:
              _target_: torch.nn.Sequential
              _args_:
                - _target_: omnivore.models.helpers.NormalizeAndBatchNorm
                  dim: -1
                  out_features: ${out_dim}
                - _target_: omnivore.models.helpers.LearnableLogitScaling
          - name: "normalize_and_scale_depth"
            postprocessor:
              _target_: torch.nn.Sequential
              _args_:
                - _target_: omnivore.models.helpers.NormalizeAndBatchNorm
                  dim: -1
                  out_features: ${out_dim}
                - _target_: omnivore.models.helpers.LearnableLogitScaling
                  logit_scale_init: 10 # 1/0.1 as in SimCLR
                  learnable: False
  optim:
    optimizer:
      _target_: torch.optim.AdamW
      betas:
        - 0.9
        - 0.98
      eps: 1e-6
    options:
      lr:
        - scheduler:
            _target_: fvcore.common.param_scheduler.CompositeParamScheduler
            schedulers:
              - _target_: fvcore.common.param_scheduler.LinearParamScheduler
                start_value: 1e-6
                end_value: 1e-3
              - _target_: fvcore.common.param_scheduler.CosineParamScheduler
                start_value: ${..0.end_value}
                end_value: 1.6e-4
            lengths:
              - ${divide:${constants.warmup_epochs},${trainer.max_epochs}}
              - ${subtract:1,${divide:${constants.warmup_epochs},${trainer.max_epochs}}}
            interval_scaling: ['rescaled', 'rescaled']
      weight_decay:
        - scheduler:
            _target_: fvcore.common.param_scheduler.ConstantParamScheduler
            value: 0.05
        - scheduler:
            _target_: fvcore.common.param_scheduler.ConstantParamScheduler
            value: 0.0
          param_names:
            - '*.bias'
            - '*pos_embed'
            - '*cls_token'
            - "*log_logit_scale"
          module_cls_names: ["torch.nn.LayerNorm"]
constants:
  sun_rgb_prefix: /fsx-omnivore/imisra/datasets/sunrgbd/images/
  sun_depth_prefix: /fsx-omnivore/imisra/datasets/sunrgbd/images_disparity/
  # sun_rgb_prefix: /checkpoint/kalyanv/data/sunrgbd/images/
  # sun_depth_prefix: /checkpoint/kalyanv/data/sunrgbd/images/
